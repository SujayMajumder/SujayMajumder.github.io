<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPL Data Narrative</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
    <style>
        body {
            font-family: sans-serif; /* Generic font */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        #visualization-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            padding: 2rem;
            width: 90%;
            max-width: 900px;
            text-align: center;
            position: relative; /* Needed for tooltip positioning */
        }
        #slide-content {
            min-height: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-in-out;
        }
        .slide-text {
            max-width: 600px;
            margin: 0 auto 1.5rem auto;
            line-height: 1.6;
            font-size: 1.1rem;
        }
        h1 {
            color: #003366; /* Dark Blue */
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        h2 {
            color: #004080; /* Medium Blue */
            font-size: 1.8rem;
            margin-bottom: 2rem;
        }
        #navigation {
            margin-top: 2rem;
        }
        button {
            background-image: linear-gradient(to right, #003366 0%, #0059b3 51%, #0073e6 100%); /* Blue gradient */
            margin: 10px;
            padding: 15px 30px;
            text-align: center;
            text-transform: uppercase;
            transition: 0.5s;
            background-size: 200% auto;
            color: white;            
            box-shadow: 0 0 20px #eee;
            border-radius: 10px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
        }

        button:hover {
            background-position: right center;
            color: #fff;
            text-decoration: none;
        }

        button:disabled {
            background-image: none;
            background-color: #ccc;
            cursor: not-allowed;
        }
        .bar {
            transition: all 0.3s ease;
        }
        .bar:hover {
            opacity: 0.7;
        }
        .axis-label {
            font-size: 0.9rem;
            font-weight: bold;
        }
        .tick text {
            font-size: 0.8rem;
        }
        
        #tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 8px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        /* Explorer Scene Styles */
        #explorer-controls {
            margin-bottom: 20px;
        }
        #explorer-controls select {
            padding: 8px;
            margin: 0 5px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        #match-list-container {
            width: 100%;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        .match-item {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .match-item:hover {
            background-color: #f0f8ff;
        }
        #scorecard-container {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            text-align: left;
            width: 100%;
        }
        .line {
            fill: none;
            stroke-width: 2px;
        }
        .wicket-dot {
            r: 4px;
            stroke: black;
            cursor: pointer;
        }
        .annotation.note-title {
            font-weight: bold;
        }
    </style>
</head>
<body>

    <div id="visualization-container">
        <div id="tooltip"></div>
        <div id="slide-content">
            <!-- Content will be injected by D3 -->
        </div>
        <div id="navigation">
            <button id="prevBtn">Previous</button>
            <button id="nextBtn">Next</button>
        </div>
    </div>

    <script>
        // --- Main Execution ---
        let currentSlideIndex = 0;
        let allSlides = [];
        let iplMatchesData = [];
        let iplDeliveriesData = [];

        // Chart dimensions
        const chartMargin = {top: 40, right: 30, bottom: 80, left: 60};
        const chartWidth = 800 - chartMargin.left - chartMargin.right;
        const chartHeight = 450 - chartMargin.top - chartMargin.bottom;

        // Tooltip
        const tooltip = d3.select("#tooltip");

        // --- Data Loading ---
        // Load both datasets before initializing the visualization
        Promise.all([
            d3.csv("matches.csv", d3.autoType),
            d3.csv("deliveries.csv", d3.autoType)
        ]).then(function([matches, deliveries]) {
            iplMatchesData = matches;
            iplDeliveriesData = deliveries;
            
            // The slides (scenes) of our story
            allSlides = [
                renderIntroScene,
                renderMatchesPerSeasonScene,
                renderTopTeamsScene,
                renderMatchExplorerScene
            ];
            
            // Start the story
            renderCurrentSlide();
        }).catch(function(error) {
            console.error("Error loading the CSV files:", error);
            d3.select("#slide-content").html(`
                <h1>Error</h1>
                <p class="slide-text">Could not load datasets. Make sure 'matches.csv' and 'deliveries.csv' are in the same folder.</p>
            `);
        });
        
        // --- Navigation Logic ---
        d3.select("#nextBtn").on("click", () => {
            if (currentSlideIndex < allSlides.length - 1) {
                currentSlideIndex++;
                renderCurrentSlide();
            }
        });

        d3.select("#prevBtn").on("click", () => {
            if (currentSlideIndex > 0) {
                currentSlideIndex--;
                renderCurrentSlide();
            }
        });

        // --- Core Rendering Function ---
        // This function handles the transition between scenes
        function renderCurrentSlide() {
            const slideContentArea = d3.select("#slide-content");
            
            // Fade out the current content
            slideContentArea.transition().duration(250).style("opacity", 0)
                .end().then(() => {
                    // Clear the content and render the new slide
                    slideContentArea.html("");
                    allSlides[currentSlideIndex]();
                    // Fade in the new content
                    slideContentArea.transition().duration(250).style("opacity", 1);
                });

            // Update the state of the navigation buttons
            d3.select("#prevBtn").property("disabled", currentSlideIndex === 0);
            d3.select("#nextBtn").property("disabled", currentSlideIndex === allSlides.length - 1);
        }

        // --- Utility for wrapping long text labels ---
        function wrapText(text, width) {
            text.each(function() {
                let textElement = d3.select(this),
                    words = textElement.text().split(/\s+/).reverse(),
                    word,
                    line = [],
                    lineNumber = 0,
                    lineHeight = 1.1, // ems
                    y = textElement.attr("y"),
                    dy = parseFloat(textElement.attr("dy")) || 0,
                    tspan = textElement.text(null).append("tspan").attr("x", 0).attr("y", y).attr("dy", dy + "em");
                
                while (word = words.pop()) {
                    line.push(word);
                    tspan.text(line.join(" "));
                    if (tspan.node().getComputedTextLength() > width) {
                        line.pop();
                        tspan.text(line.join(" "));
                        line = [word];
                        tspan = textElement.append("tspan").attr("x", 0).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
                    }
                }
            });
        }
        
        // --- Scene Definitions ---

        function renderIntroScene() {
            d3.select("#slide-content").html(`
                <h1>A Narrative of the Indian Premier League (IPL)</h1>
                <p class="slide-text">Welcome! This interactive slideshow explores key trends from the IPL, one of the world's most exciting cricket tournaments.</p>
                <p class="slide-text">We'll look at matches per season, dominant teams, and explore individual match scorecards. <strong>Hover over the charts for more details.</strong> Click 'Next' to begin.</p>
            `);
        }

        function renderMatchesPerSeasonScene() {
            const content = d3.select("#slide-content");
            content.html(`
                <h2>Matches Played Each Season</h2>
                <p class="slide-text">The number of matches fluctuated per season, often reflecting changes in the tournament format. Hover over a bar to see the exact count.</p>
            `);

            const matchesPerSeason = d3.rollup(iplMatchesData, v => v.length, d => d.season);
            const seasonData = Array.from(matchesPerSeason, ([key, value]) => ({season: key, matches: value}))
                                  .sort((a, b) => d3.ascending(a.season, b.season));
            
            const svg = content.append("svg").attr("width", chartWidth + chartMargin.left + chartMargin.right).attr("height", chartHeight + chartMargin.top + chartMargin.bottom)
                .append("g").attr("transform", `translate(${chartMargin.left},${chartMargin.top})`);

            const x = d3.scaleBand().range([0, chartWidth]).domain(seasonData.map(d => d.season)).padding(0.2);
            svg.append("g").attr("transform", `translate(0,${chartHeight})`).call(d3.axisBottom(x))
               .selectAll("text").attr("transform", "translate(-10,0)rotate(-45)").style("text-anchor", "end");

            const y = d3.scaleLinear().domain([0, d3.max(seasonData, d => d.matches)]).range([chartHeight, 0]);
            svg.append("g").call(d3.axisLeft(y));

            svg.selectAll(".bar").data(seasonData).join("rect").attr("class", "bar")
                .attr("x", d => x(d.season)).attr("y", y(0))
                .attr("width", x.bandwidth()).attr("height", 0)
                .attr("fill", "#0059b3")
                .on("mouseover", (event, d) => tooltip.style("opacity", 1))
                .on("mousemove", (event, d) => {
                    const [posX, posY] = d3.pointer(event, d3.select('#visualization-container').node());
                    tooltip.html(`Season: ${d.season}<br>Matches: ${d.matches}`).style("left", (posX + 15) + "px").style("top", (posY) + "px");
                })
                .on("mouseleave", () => tooltip.style("opacity", 0))
                .transition().duration(800).attr("y", d => y(d.matches)).attr("height", d => chartHeight - y(d.matches));
        }

        function renderTopTeamsScene() {
            const content = d3.select("#slide-content");
            content.html(`
                <h2>Top 5 Most Dominant Teams</h2>
                <p class="slide-text">Winning is everything. This chart reveals the top 5 teams with the most victories. Hover over a bar to see the exact win count and titles won.</p>
            `);

            const finalMatchesBySeason = d3.rollup(iplMatchesData, v => d3.max(v, d => d.id), d => d.season);
            const championshipWinners = new Map();
            finalMatchesBySeason.forEach(matchId => {
                const finalMatch = iplMatchesData.find(d => d.id === matchId);
                if (finalMatch && finalMatch.winner) {
                    championshipWinners.set(finalMatch.winner, (championshipWinners.get(finalMatch.winner) || 0) + 1);
                }
            });

            const winsPerTeam = d3.rollup(iplMatchesData, v => v.length, d => d.winner);
            winsPerTeam.delete(""); winsPerTeam.delete(null);
            
            const teamData = Array.from(winsPerTeam, ([key, value]) => ({
                team: key, wins: value, championships: championshipWinners.get(key) || 0
            })).sort((a, b) => d3.descending(a.wins, b.wins)).slice(0, 5);
            
            const svg = content.append("svg").attr("width", chartWidth + chartMargin.left + chartMargin.right).attr("height", chartHeight + chartMargin.top + chartMargin.bottom)
                .append("g").attr("transform", `translate(${chartMargin.left},${chartMargin.top})`);

            const x = d3.scaleBand().range([0, chartWidth]).domain(teamData.map(d => d.team)).padding(0.2);
            svg.append("g").attr("transform", `translate(0,${chartHeight})`).call(d3.axisBottom(x))
               .selectAll(".tick text").call(wrapText, x.bandwidth());

            const y = d3.scaleLinear().domain([0, d3.max(teamData, d => d.wins)]).range([chartHeight, 0]);
            svg.append("g").call(d3.axisLeft(y));

            svg.selectAll(".bar").data(teamData).join("rect").attr("class", "bar")
                .attr("x", d => x(d.team)).attr("y", y(0))
                .attr("width", x.bandwidth()).attr("height", 0)
                .attr("fill", "#0059b3")
                .on("mouseover", (event, d) => tooltip.style("opacity", 1))
                .on("mousemove", (event, d) => {
                    const [posX, posY] = d3.pointer(event, d3.select('#visualization-container').node());
                    tooltip.html(`${d.team}<br>Total Wins: ${d.wins}<br>IPL Titles: ${d.championships}`).style("left", (posX + 15) + "px").style("top", (posY) + "px");
                })
                .on("mouseleave", () => tooltip.style("opacity", 0))
                .transition().duration(800).attr("y", d => y(d.wins)).attr("height", d => chartHeight - y(d.wins));
        }

        function renderMatchExplorerScene() {
            const content = d3.select("#slide-content");
            content.html(`
                <h2>Match Explorer</h2>
                <p class="slide-text">Select a year and a team to see their match results. Click a match to see the scorecard and run progression chart.</p>
                <div id="explorer-controls">
                    <select id="year-select"><option>Select a Year</option></select>
                    <select id="team-select" disabled><option>Select a Team</option></select>
                </div>
                <div id="match-list-container"></div>
                <div id="scorecard-container"></div>
            `);

            const seasons = [...new Set(iplMatchesData.map(d => d.season))].sort(d3.descending);
            const yearSelect = d3.select("#year-select");
            yearSelect.selectAll("option.year-option").data(seasons).enter().append("option").attr("class", "year-option").text(d => d);

            yearSelect.on("change", function() {
                const selectedYear = d3.select(this).property("value");
                const teamSelect = d3.select("#team-select");
                d3.select("#match-list-container").html("");
                d3.select("#scorecard-container").html("");

                if (!selectedYear || selectedYear === "Select a Year") {
                    teamSelect.property("disabled", true).html("<option>Select a Team</option>");
                    return;
                }
                const teamsInSeason = new Set();
                iplMatchesData.filter(d => d.season == selectedYear).forEach(d => { teamsInSeason.add(d.team1); teamsInSeason.add(d.team2); });
                teamSelect.property("disabled", false).html("<option>Select a Team</option>").selectAll("option.team-option")
                    .data([...teamsInSeason].sort()).enter().append("option").attr("class", "team-option").text(d => d);
            });

            d3.select("#team-select").on("change", function() {
                const selectedTeam = d3.select(this).property("value");
                const selectedYear = d3.select("#year-select").property("value");
                const matchListContainer = d3.select("#match-list-container");
                d3.select("#scorecard-container").html("");

                if (!selectedTeam || selectedTeam === "Select a Team") { matchListContainer.html(""); return; }

                const teamMatches = iplMatchesData.filter(d => d.season == selectedYear && (d.team1 === selectedTeam || d.team2 === selectedTeam));
                matchListContainer.selectAll("div.match-item").data(teamMatches).join("div").attr("class", "match-item")
                    .html(d => `${d.team1} vs ${d.team2} <br><small>${d.winner} won by ${d.win_by_runs > 0 ? `${d.win_by_runs} runs` : `${d.win_by_wickets} wickets`}</small>`)
                    .on("click", (event, d) => displayScorecard(d.id));
            });
        }

        function displayScorecard(matchId) {
            const scorecardContainer = d3.select("#scorecard-container").html("");
            const matchDetails = iplMatchesData.find(d => d.id === matchId);
            const matchDeliveries = iplDeliveriesData.filter(d => d.match_id === matchId);

            let scorecardHTML = `<h3>Scorecard: ${matchDetails.team1} vs ${matchDetails.team2}</h3><p><strong>Result:</strong> ${matchDetails.winner} won. <strong>Player of the Match:</strong> ${matchDetails.player_of_match}</p><hr>`;
            scorecardContainer.append("div").html(scorecardHTML);

            const vizMargin = {top: 20, right: 120, bottom: 60, left: 50};
            const vizWidth = 800 - vizMargin.left - vizMargin.right;
            const vizHeight = 350 - vizMargin.top - vizMargin.bottom;

            const svg = scorecardContainer.append("svg")
                .attr("width", vizWidth + vizMargin.left + vizMargin.right)
                .attr("height", vizHeight + vizMargin.top + vizMargin.bottom)
                .append("g")
                .attr("transform", `translate(${vizMargin.left},${vizMargin.top})`);

            const inningsData = [];
            const innings = d3.group(matchDeliveries, d => d.inning);
            let maxRuns = 0;
            let finalScores = [];

            innings.forEach((inningDeliveries, inningNum) => {
                let cumulativeRuns = 0, ballCounter = 0, wicketCounter = 0;
                const runProgression = inningDeliveries.map(d => {
                    cumulativeRuns += d.total_runs;
                    ballCounter++;
                    if (d.player_dismissed) wicketCounter++;
                    if(cumulativeRuns > maxRuns) maxRuns = cumulativeRuns;
                    return { ball: ballCounter, runs: cumulativeRuns, wicket: d.player_dismissed ? { player: d.player_dismissed, kind: d.dismissal_kind } : null };
                });
                const finalScore = runProgression[runProgression.length - 1];
                finalScores.push({ ...finalScore, wickets: wicketCounter, team: inningDeliveries[0].batting_team });
                inningsData.push({inning: inningNum, team: inningDeliveries[0].batting_team, progression: runProgression});
            });

            const x = d3.scaleLinear().domain([0, d3.max(inningsData, d => d.progression.length)]).range([0, vizWidth]);
            svg.append("g").attr("transform", `translate(0, ${vizHeight})`).call(d3.axisBottom(x).ticks(10).tickFormat(d => Math.floor(d/6)));
            svg.append("text").attr("class", "axis-label").attr("text-anchor", "middle").attr("x", vizWidth / 2).attr("y", vizHeight + vizMargin.bottom - 20).text("Over");
            
            const y = d3.scaleLinear().domain([0, maxRuns * 1.1]).range([vizHeight, 0]);
            svg.append("g").call(d3.axisLeft(y));
            svg.append("text").attr("class", "axis-label").attr("text-anchor", "middle").attr("transform", "rotate(-90)").attr("y", -vizMargin.left + 20).attr("x", -vizHeight / 2).text("Runs");

            const color = d3.scaleOrdinal(d3.schemeCategory10);
            
            const legendGroup = svg.append("g")
                .attr("class", "legend")
                .attr("transform", `translate(${vizWidth + 20}, ${vizHeight - 40})`);

            const legendItems = legendGroup.selectAll(".legend-item")
                .data(inningsData)
                .join("g")
                .attr("class", "legend-item")
                .attr("transform", (d, i) => `translate(0, ${i * 25})`);

            legendItems.append("circle").attr("cx", 0).attr("cy", 0).attr("r", 6).style("fill", (d, i) => color(i));
            legendItems.append("text").attr("x", 10).attr("y", 0).text(d => d.team).style("font-size", "12px").attr("alignment-baseline", "middle");

            inningsData.forEach((inning, i) => {
                const line = d3.line().x(d => x(d.ball)).y(d => y(d.runs));
                svg.append("path").datum(inning.progression).attr("class", "line").attr("d", line).style("stroke", color(i));

                svg.selectAll(`.wicket-dot-inning-${i}`).data(inning.progression.filter(d => d.wicket))
                    .enter().append("circle").attr("class", `wicket-dot wicket-dot-inning-${i}`)
                    .attr("cx", d => x(d.ball)).attr("cy", d => y(d.runs))
                    .style("fill", color(i))
                    .on("mouseover", (event, d) => {
                        tooltip.style("opacity", 1).html(`Wicket: ${d.wicket.player}<br>(${d.wicket.kind})`);
                    })
                    .on("mousemove", (event) => {
                        const [posX, posY] = d3.pointer(event, d3.select('#visualization-container').node());
                        tooltip.style("left", (posX + 15) + "px").style("top", (posY) + "px");
                    })
                    .on("mouseleave", () => tooltip.style("opacity", 0));
            });

            const type = d3.annotationLabel;
            const annotations = finalScores.map((score, i) => ({
                note: { label: `${score.runs}/${score.wickets}`, title: score.team, wrap: 150 },
                x: x(score.ball), y: y(score.runs), dy: i === 0 ? -30 : 30, dx: -30
            }));

            const makeAnnotations = d3.annotation().type(type).annotations(annotations);
            svg.append("g").attr("class", "annotation-group").call(makeAnnotations);
        }

    </script>
</body>
</html>
