<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IPL Data Narrative</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://rawgit.com/susielu/d3-annotation/master/d3-annotation.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
        }
        #visualization-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.1);
            padding: 2rem;
            width: 90%;
            max-width: 900px;
            text-align: center;
            position: relative; /* Needed for tooltip positioning */
        }
        #slide-content {
            min-height: 500px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease-in-out;
        }
        .slide-text {
            max-width: 600px;
            margin: 0 auto 1.5rem auto;
            line-height: 1.6;
            font-size: 1.1rem;
        }
        h1 {
            color: #1a2a6c;
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }
        h2 {
            color: #b21f1f;
            font-size: 1.8rem;
            margin-bottom: 2rem;
        }
        #navigation {
            margin-top: 2rem;
        }
        button {
            background-image: linear-gradient(to right, #1a2a6c 0%, #b21f1f 51%, #f64f59 100%);
            margin: 10px;
            padding: 15px 30px;
            text-align: center;
            text-transform: uppercase;
            transition: 0.5s;
            background-size: 200% auto;
            color: white;            
            box-shadow: 0 0 20px #eee;
            border-radius: 10px;
            border: none;
            font-size: 1rem;
            cursor: pointer;
        }

        button:hover {
            background-position: right center;
            color: #fff;
            text-decoration: none;
        }

        button:disabled {
            background-image: none;
            background-color: #ccc;
            cursor: not-allowed;
        }
        .bar {
            transition: all 0.3s ease;
        }
        .bar:hover {
            opacity: 0.7;
        }
        .axis-label {
            font-size: 0.9rem;
            font-weight: bold;
        }
        .tick text {
            font-size: 0.8rem;
        }
        
        /* Tooltip Styling */
        #tooltip {
            position: absolute;
            text-align: center;
            width: auto;
            height: auto;
            padding: 8px;
            font: 12px sans-serif;
            background: lightsteelblue;
            border: 0px;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        /* Annotation Styling */
        .annotation-group .annotation-note-label {
            font-size: 14px;
        }
    </style>
</head>
<body>

    <div id="visualization-container">
        <div id="tooltip"></div>
        <div id="slide-content">
            <!-- Content will be injected by D3 -->
        </div>
        <div id="navigation">
            <button id="prevBtn">Previous</button>
            <button id="nextBtn">Next</button>
        </div>
    </div>

    <script>
        // --- CSV Data Embedded ---
        const csvData = `id,season,city,date,team1,team2,toss_winner,toss_decision,result,dl_applied,winner,win_by_runs,win_by_wickets,player_of_match,venue,umpire1,umpire2,umpire3
1,2017,Hyderabad,2017-04-05,Sunrisers Hyderabad,Royal Challengers Bangalore,Royal Challengers Bangalore,field,normal,0,Sunrisers Hyderabad,35,0,Yuvraj Singh,"Rajiv Gandhi International Stadium, Uppal",AY Dandekar,NJ Llong,
2,2017,Pune,2017-04-06,Mumbai Indians,Rising Pune Supergiant,Rising Pune Supergiant,field,normal,0,Rising Pune Supergiant,0,7,SPD Smith,Maharashtra Cricket Association Stadium,A Nand Kishore,S Ravi,
3,2017,Rajkot,2017-04-07,Gujarat Lions,Kolkata Knight Riders,Kolkata Knight Riders,field,normal,0,Kolkata Knight Riders,0,10,CA Lynn,Saurashtra Cricket Association Stadium,Nitin Menon,CK Nandan,
4,2017,Indore,2017-04-08,Rising Pune Supergiant,Kings XI Punjab,Kings XI Punjab,field,normal,0,Kings XI Punjab,0,6,GJ Maxwell,Holkar Cricket Stadium,AK Chaudhary,C Shamshuddin,
5,2017,Bangalore,2017-04-08,Royal Challengers Bangalore,Delhi Daredevils,Royal Challengers Bangalore,bat,normal,0,Royal Challengers Bangalore,15,0,KM Jadhav,M Chinnaswamy Stadium,AK Chaudhary,C Shamshuddin,
6,2017,Hyderabad,2017-04-09,Gujarat Lions,Sunrisers Hyderabad,Sunrisers Hyderabad,field,normal,0,Sunrisers Hyderabad,0,9,Rashid Khan,"Rajiv Gandhi International Stadium, Uppal",A Deshmukh,NJ Llong,
7,2017,Mumbai,2017-04-09,Kolkata Knight Riders,Mumbai Indians,Mumbai Indians,field,normal,0,Mumbai Indians,0,4,N Rana,Wankhede Stadium,Nitin Menon,CK Nandan,
8,2017,Indore,2017-04-10,Royal Challengers Bangalore,Kings XI Punjab,Royal Challengers Bangalore,bat,normal,0,Kings XI Punjab,0,8,AR Patel,Holkar Cricket Stadium,AK Chaudhary,C Shamshuddin,
9,2017,Pune,2017-04-11,Delhi Daredevils,Rising Pune Supergiant,Rising Pune Supergiant,field,normal,0,Delhi Daredevils,97,0,SV Samson,Maharashtra Cricket Association Stadium,AY Dandekar,S Ravi,
10,2017,Mumbai,2017-04-12,Sunrisers Hyderabad,Mumbai Indians,Mumbai Indians,field,normal,0,Mumbai Indians,0,4,JJ Bumrah,Wankhede Stadium,Nitin Menon,CK Nandan,
11,2017,Kolkata,2017-04-13,Kings XI Punjab,Kolkata Knight Riders,Kolkata Knight Riders,field,normal,0,Kolkata Knight Riders,0,8,SP Narine,Eden Gardens,A Deshmukh,NJ Llong,
12,2017,Bangalore,2017-04-14,Royal Challengers Bangalore,Mumbai Indians,Mumbai Indians,field,normal,0,Mumbai Indians,0,4,KA Pollard,M Chinnaswamy Stadium,KN Ananthapadmanabhan,AK Chaudhary,
13,2017,Rajkot,2017-04-14,Rising Pune Supergiant,Gujarat Lions,Gujarat Lions,field,normal,0,Gujarat Lions,0,7,AJ Tye,Saurashtra Cricket Association Stadium,A Nand Kishore,S Ravi,
59,2017,Bangalore,2017-05-19,Kolkata Knight Riders,Mumbai Indians,Mumbai Indians,field,normal,0,Mumbai Indians,0,6,KV Sharma,M Chinnaswamy Stadium,NJ Llong,Nitin Menon,
60,2017,Hyderabad,2017-05-21,Mumbai Indians,Rising Pune Supergiant,Mumbai Indians,bat,normal,0,Mumbai Indians,1,0,KH Pandya,"Rajiv Gandhi International Stadium, Uppal",NJ Llong,S Ravi,
61,2008,Bangalore,2008-04-18,Kolkata Knight Riders,Royal Challengers Bangalore,Royal Challengers Bangalore,field,normal,0,Kolkata Knight Riders,140,0,BB McCullum,M Chinnaswamy Stadium,Asad Rauf,RE Koertzen,
117,2008,Mumbai,2008-06-01,Chennai Super Kings,Rajasthan Royals,Rajasthan Royals,field,normal,0,Rajasthan Royals,0,3,YK Pathan,Dr DY Patil Sports Academy,BF Bowden,RE Koertzen,
118,2009,Cape Town,2009-04-18,Mumbai Indians,Chennai Super Kings,Chennai Super Kings,field,normal,0,Mumbai Indians,19,0,SR Tendulkar,Newlands,BR Doctrove,K Hariharan,
174,2009,Johannesburg,2009-05-24,Deccan Chargers,Royal Challengers Bangalore,Royal Challengers Bangalore,field,normal,0,Deccan Chargers,6,0,A Kumble,New Wanderers Stadium,RE Koertzen,SJA Taufel,
175,2010,Mumbai,2010-03-12,Kolkata Knight Riders,Deccan Chargers,Deccan Chargers,field,normal,0,Kolkata Knight Riders,11,0,AD Mathews,Dr DY Patil Sports Academy,RE Koertzen,AM Saheba,
234,2010,Mumbai,2010-04-25,Chennai Super Kings,Mumbai Indians,Chennai Super Kings,bat,normal,0,Chennai Super Kings,22,0,SK Raina,Dr DY Patil Sports Academy,RE Koertzen,SJA Taufel,
235,2011,Chennai,2011-04-08,Chennai Super Kings,Kolkata Knight Riders,Chennai Super Kings,bat,normal,0,Chennai Super Kings,2,0,S Anirudha,MA Chidambaram Stadium, Chepauk,BR Doctrove,PR Reiffel,
307,2011,Mumbai,2011-05-28,Chennai Super Kings,Royal Challengers Bangalore,Chennai Super Kings,bat,normal,0,Chennai Super Kings,58,0,M Vijay,Wankhede Stadium,Asad Rauf,SJA Taufel,
308,2012,Chennai,2012-04-04,Chennai Super Kings,Mumbai Indians,Mumbai Indians,field,normal,0,Mumbai Indians,0,8,RE Levi,MA Chidambaram Stadium, Chepauk,S Asnani,SJA Taufel,
381,2012,Chennai,2012-05-27,Chennai Super Kings,Kolkata Knight Riders,Chennai Super Kings,bat,normal,0,Kolkata Knight Riders,0,5,MS Bisla,MA Chidambaram Stadium, Chepauk,BF Bowden,SJA Taufel,
382,2013,Kolkata,2013-04-03,Delhi Daredevils,Kolkata Knight Riders,Kolkata Knight Riders,field,normal,0,Kolkata Knight Riders,0,6,SP Narine,Eden Gardens,S Asnani,SJA Taufel,
457,2013,Kolkata,2013-05-26,Mumbai Indians,Chennai Super Kings,Mumbai Indians,bat,normal,0,Mumbai Indians,23,0,KA Pollard,Eden Gardens,HDPK Dharmasena,SJA Taufel,
458,2014,Abu Dhabi,2014-04-16,Kolkata Knight Riders,Mumbai Indians,Kolkata Knight Riders,bat,normal,0,Kolkata Knight Riders,41,0,JH Kallis,Sheikh Zayed Stadium,M Erasmus,S Ravi,
517,2014,Bangalore,2014-06-01,Kings XI Punjab,Kolkata Knight Riders,Kolkata Knight Riders,field,normal,0,Kolkata Knight Riders,0,3,MK Pandey,M Chinnaswamy Stadium,HDPK Dharmasena,BNJ Oxenford,
518,2015,Kolkata,2015-04-08,Mumbai Indians,Kolkata Knight Riders,Kolkata Knight Riders,field,normal,0,Kolkata Knight Riders,0,7,M Morkel,Eden Gardens,S Ravi,C Shamshuddin,
576,2015,Kolkata,2015-05-24,Mumbai Indians,Chennai Super Kings,Chennai Super Kings,field,normal,0,Mumbai Indians,41,0,RG Sharma,Eden Gardens,HDPK Dharmasena,RK Illingworth,
577,2016,Mumbai,2016-04-09,Mumbai Indians,Rising Pune Supergiants,Mumbai Indians,bat,normal,0,Rising Pune Supergiants,0,9,AM Rahane,Wankhede Stadium,HDPK Dharmasena,CK Nandan,
636,2016,Bangalore,2016-05-29,Sunrisers Hyderabad,Royal Challengers Bangalore,Sunrisers Hyderabad,bat,normal,0,Sunrisers Hyderabad,8,0,BCJ Cutting,M Chinnaswamy Stadium,HDPK Dharmasena,BNJ Oxenford,
`;

        // --- Main Execution ---
        let slideIndex = 0;
        let slides = [];
        let data = [];

        // Chart dimensions
        const margin = {top: 40, right: 30, bottom: 70, left: 60}; // Increased bottom margin for labels
        const width = 800 - margin.left - margin.right;
        const height = 450 - margin.top - margin.bottom;

        // Tooltip
        const tooltip = d3.select("#tooltip");

        // --- Initialize Visualization ---
        try {
            data = d3.csvParse(csvData, d3.autoType); // Use autoType to parse numbers
            console.log("Data parsed successfully:", data);

            slides = [
                scene1_Intro,
                scene2_MatchesPerSeason,
                scene3_TopWinningTeams
            ];
            
            renderSlide();
        } catch (error) {
            console.error("Error parsing the CSV data:", error);
            d3.select("#slide-content").html(`<h1>Error</h1><p class="slide-text">Could not parse the dataset.</p>`);
        }
        
        // --- Event Listeners ---
        d3.select("#nextBtn").on("click", () => {
            if (slideIndex < slides.length - 1) {
                slideIndex++;
                renderSlide();
            }
        });

        d3.select("#prevBtn").on("click", () => {
            if (slideIndex > 0) {
                slideIndex--;
                renderSlide();
            }
        });

        // --- Core Functions ---
        function renderSlide() {
            const content = d3.select("#slide-content");
            content.transition().duration(250).style("opacity", 0)
                .end().then(() => {
                    content.html("");
                    slides[slideIndex]();
                    content.transition().duration(250).style("opacity", 1);
                });

            d3.select("#prevBtn").property("disabled", slideIndex === 0);
            d3.select("#nextBtn").property("disabled", slideIndex === slides.length - 1);
        }
        
        // --- Slide Definitions ---

        function scene1_Intro() {
            const content = d3.select("#slide-content");
            content.html(`
                <h1>A Narrative of the Indian Premier League (IPL)</h1>
                <p class="slide-text">Welcome! This interactive slideshow explores key trends from the IPL, one of the world's most exciting cricket tournaments.</p>
                <p class="slide-text">We'll look at matches per season and dominant teams. <strong>Hover over the charts for more details.</strong> Click 'Next' to begin.</p>
            `);
        }

        function scene2_MatchesPerSeason() {
            const content = d3.select("#slide-content");
            content.html(`
                <h2>Matches Played Each Season</h2>
                <p class="slide-text">The number of matches fluctuated per season, often reflecting changes in the tournament format. Hover over a bar to see the exact count.</p>
            `);

            const matchesPerSeason = d3.rollup(data, v => v.length, d => d.season);
            const seasonData = Array.from(matchesPerSeason, ([key, value]) => ({season: key, matches: value}))
                                  .sort((a, b) => d3.ascending(a.season, b.season));
            
            const svg = content.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand().range([0, width]).domain(seasonData.map(d => d.season)).padding(0.2);
            svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x))
               .selectAll("text").attr("transform", "translate(-10,0)rotate(-45)").style("text-anchor", "end");

            const y = d3.scaleLinear().domain([0, d3.max(seasonData, d => d.matches)]).range([height, 0]);
            svg.append("g").call(d3.axisLeft(y));

            // Tooltip functions
            const mouseover = (event, d) => {
                tooltip.style("opacity", 1);
            };
            const mousemove = (event, d) => {
                tooltip.html(`Season: ${d.season}<br>Matches: ${d.matches}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            };
            const mouseleave = (event, d) => {
                tooltip.style("opacity", 0);
            };

            svg.selectAll("rect")
                .data(seasonData)
                .join("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.season))
                .attr("y", d => y(0))
                .attr("width", x.bandwidth())
                .attr("height", 0)
                .attr("fill", "#1a2a6c")
                .on("mouseover", mouseover)
                .on("mousemove", mousemove)
                .on("mouseleave", mouseleave)
                .transition().duration(800)
                .attr("y", d => y(d.matches))
                .attr("height", d => height - y(d.matches));
            
            // --- Annotation ---
            const peakSeason = seasonData.reduce((prev, current) => (prev.matches > current.matches) ? prev : current);
            const type = d3.annotationLabel;
            const annotations = [{
                note: { label: `The most matches (${peakSeason.matches}) were played in ${peakSeason.season}.`, title: "Peak Season", wrap: 150 },
                x: x(peakSeason.season) + x.bandwidth() / 2,
                y: y(peakSeason.matches),
                dy: -20,
                dx: 0
            }];

            const makeAnnotations = d3.annotation().type(type).annotations(annotations);
            svg.append("g").attr("class", "annotation-group").call(makeAnnotations);
        }

        function scene3_TopWinningTeams() {
            const content = d3.select("#slide-content");
            content.html(`
                <h2>Top 5 Most Dominant Teams</h2>
                <p class="slide-text">Winning is everything. This chart reveals the top 5 teams with the most victories. Hover over a bar to see the exact win count.</p>
            `);

            const winsPerTeam = d3.rollup(data, v => v.length, d => d.winner);
            winsPerTeam.delete(""); 
            winsPerTeam.delete(null);
            const teamData = Array.from(winsPerTeam, ([key, value]) => ({team: key, wins: value}))
                                  .sort((a, b) => d3.descending(a.wins, b.wins))
                                  .slice(0, 5);
            
            const svg = content.append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
                .append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand().range([0, width]).domain(teamData.map(d => d.team)).padding(0.2);
            svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x))
               .selectAll("text").style("text-anchor", "end").attr("dx", "-.8em").attr("dy", ".15em").attr("transform", "rotate(-25)");

            const y = d3.scaleLinear().domain([0, d3.max(teamData, d => d.wins)]).range([height, 0]);
            svg.append("g").call(d3.axisLeft(y));

            const mouseover = (event, d) => tooltip.style("opacity", 1);
            const mousemove = (event, d) => {
                tooltip.html(`${d.team}<br>Wins: ${d.wins}`)
                    .style("left", (event.pageX + 10) + "px")
                    .style("top", (event.pageY - 28) + "px");
            };
            const mouseleave = (event, d) => tooltip.style("opacity", 0);

            svg.selectAll("rect")
                .data(teamData)
                .join("rect")
                .attr("class", "bar")
                .attr("x", d => x(d.team))
                .attr("y", y(0))
                .attr("width", x.bandwidth())
                .attr("height", 0)
                .attr("fill", "#b21f1f")
                .on("mouseover", mouseover)
                .on("mousemove", mousemove)
                .on("mouseleave", mouseleave)
                .transition().duration(800)
                .attr("y", d => y(d.wins))
                .attr("height", d => height - y(d.wins));

            // --- Annotation ---
            const topTeam = teamData[0];
            // Changed annotation type to d3.annotationLabel for consistency
            const type = d3.annotationLabel; 
            const annotations = [{
                note: { label: `${topTeam.team} leads with ${topTeam.wins} wins.`, title: "Top Team", wrap: 150 },
                x: x(topTeam.team) + x.bandwidth() / 2,
                y: y(topTeam.wins),
                dy: -30, // Adjusted for better positioning
                dx: 30  // Adjusted for better positioning
            }];

            const makeAnnotations = d3.annotation().type(type).annotations(annotations);
            svg.append("g").attr("class", "annotation-group").call(makeAnnotations);
        }

    </script>
</body>
</html>
